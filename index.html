<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <title>ğŸ¬ AI å½±ç‰‡ç”Ÿæˆå™¨</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        :root {
            --bg:#0a0a0f;
            --card:rgba(20,20,30,0.9);
            --glass:rgba(255,255,255,0.05);
            --border:rgba(255,255,255,0.1);
            --primary:#a855f7;
            --secondary:#ec4899;
            --accent:#06b6d4;
            --text:#fff;
            --text2:rgba(255,255,255,0.6);
        }
        body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; overflow-x:hidden; }
        
        /* ===== é–‹æ©Ÿå‹•ç•« - ã€Œå½±ã€å­—ç§‘å¹»é¢¨ ===== */
        .splash {
            position:fixed; inset:0; z-index:9999;
            background:linear-gradient(135deg,#0a0a0f 0%,#1a0a2e 50%,#0a1628 100%);
            display:flex; flex-direction:column; justify-content:center; align-items:center;
            transition:opacity 0.8s, visibility 0.8s;
        }
        .splash.hide { opacity:0; visibility:hidden; pointer-events:none; }
        
        .splash-container {
            position:relative;
            width:280px; height:280px;
            perspective:1000px;
        }
        
        /* å¤–åœˆæ—‹è½‰å…‰ç’° */
        .ring-outer {
            position:absolute; inset:-40px;
            border:2px solid transparent;
            border-top-color:var(--primary);
            border-radius:50%;
            animation:spinRing 3s linear infinite;
        }
        .ring-outer::before {
            content:''; position:absolute; inset:-10px;
            border:1px solid transparent;
            border-right-color:var(--secondary);
            border-radius:50%;
            animation:spinRing 2s linear infinite reverse;
        }
        
        /* ä¸­åœˆè„ˆè¡ */
        .ring-mid {
            position:absolute; inset:20px;
            border:1px solid var(--accent);
            border-radius:50%;
            animation:pulse 2s ease-in-out infinite;
            box-shadow:0 0 30px rgba(6,182,212,0.3), inset 0 0 30px rgba(6,182,212,0.1);
        }
        
        /* ã€Œå½±ã€å­— 3D æ—‹è½‰ */
        .char-box {
            position:absolute; inset:0;
            display:flex; justify-content:center; align-items:center;
            transform-style:preserve-3d;
            animation:rotate3D 4s ease-in-out infinite;
        }
        
        .char {
            font-size:120px;
            font-weight:900;
            background:linear-gradient(135deg,#a855f7 0%,#ec4899 50%,#06b6d4 100%);
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
            background-clip:text;
            filter:drop-shadow(0 0 20px rgba(168,85,247,0.5)) drop-shadow(0 0 40px rgba(236,72,153,0.3));
            animation:glowPulse 2s ease-in-out infinite;
        }
        
        /* æƒæç·šæ•ˆæœ */
        .scan-line {
            position:absolute;
            width:100%;
            height:3px;
            background:linear-gradient(90deg,transparent,var(--accent),transparent);
            animation:scanMove 2s linear infinite;
            box-shadow:0 0 20px var(--accent);
        }
        
        /* ç²’å­æ•ˆæœ */
        .particles {
            position:absolute; inset:-50px;
            pointer-events:none;
        }
        .particle {
            position:absolute;
            width:4px; height:4px;
            background:var(--primary);
            border-radius:50%;
            animation:particleFloat 3s ease-in-out infinite;
        }
        .particle:nth-child(2) { left:20%; animation-delay:0.5s; background:var(--secondary); }
        .particle:nth-child(3) { left:40%; animation-delay:1s; background:var(--accent); }
        .particle:nth-child(4) { left:60%; animation-delay:1.5s; background:var(--primary); }
        .particle:nth-child(5) { left:80%; animation-delay:2s; background:var(--secondary); }
        .particle:nth-child(6) { left:90%; animation-delay:2.5s; background:var(--accent); }
        
        /* ç§‘æŠ€æ ¼ç·šèƒŒæ™¯ */
        .grid-bg {
            position:absolute; inset:0;
            background-image:
                linear-gradient(rgba(168,85,247,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(168,85,247,0.03) 1px, transparent 1px);
            background-size:50px 50px;
            animation:gridMove 20s linear infinite;
        }
        
        .splash-title {
            margin-top:40px;
            font-size:24px;
            font-weight:700;
            background:linear-gradient(90deg,var(--primary),var(--secondary),var(--accent));
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
            background-clip:text;
            letter-spacing:8px;
            animation:titleGlow 2s ease-in-out infinite;
        }
        
        .splash-sub {
            margin-top:12px;
            font-size:12px;
            color:var(--text2);
            letter-spacing:4px;
        }
        
        .loading-bar {
            margin-top:30px;
            width:200px; height:3px;
            background:rgba(255,255,255,0.1);
            border-radius:2px;
            overflow:hidden;
        }
        .loading-bar::after {
            content:'';
            display:block;
            width:40%;
            height:100%;
            background:linear-gradient(90deg,var(--primary),var(--secondary),var(--accent));
            animation:loadingMove 1.5s ease-in-out infinite;
        }
        
        @keyframes spinRing { to { transform:rotate(360deg); } }
        @keyframes pulse { 0%,100% { transform:scale(1); opacity:0.5; } 50% { transform:scale(1.1); opacity:1; } }
        @keyframes rotate3D {
            0% { transform:rotateY(0deg) rotateX(0deg); }
            25% { transform:rotateY(15deg) rotateX(5deg); }
            50% { transform:rotateY(0deg) rotateX(0deg); }
            75% { transform:rotateY(-15deg) rotateX(-5deg); }
            100% { transform:rotateY(0deg) rotateX(0deg); }
        }
        @keyframes glowPulse { 0%,100% { filter:drop-shadow(0 0 20px rgba(168,85,247,0.5)) drop-shadow(0 0 40px rgba(236,72,153,0.3)); } 50% { filter:drop-shadow(0 0 40px rgba(168,85,247,0.8)) drop-shadow(0 0 60px rgba(236,72,153,0.5)); } }
        @keyframes scanMove { 0% { top:-10%; opacity:0; } 50% { opacity:1; } 100% { top:110%; opacity:0; } }
        @keyframes particleFloat { 0%,100% { transform:translateY(0) scale(1); opacity:0.5; } 50% { transform:translateY(-100px) scale(1.5); opacity:1; } }
        @keyframes gridMove { to { background-position:50px 50px; } }
        @keyframes titleGlow { 0%,100% { opacity:1; } 50% { opacity:0.8; } }
        @keyframes loadingMove { 0% { transform:translateX(-100%); } 100% { transform:translateX(350%); } }
        
        /* ===== ä¸»ä»‹é¢ ===== */
        .app { padding:20px 16px 100px; max-width:600px; margin:0 auto; }
        
        .header {
            text-align:center;
            padding:20px 0;
        }
        .header h1 {
            font-size:28px;
            background:linear-gradient(135deg,var(--primary),var(--secondary));
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
            background-clip:text;
        }
        .header p { color:var(--text2); font-size:14px; margin-top:8px; }
        
        /* å¡ç‰‡ */
        .card {
            background:var(--card);
            border:1px solid var(--border);
            border-radius:20px;
            padding:20px;
            margin-bottom:16px;
            backdrop-filter:blur(20px);
        }
        .card-title {
            font-size:14px;
            color:var(--text2);
            margin-bottom:16px;
            display:flex;
            align-items:center;
            gap:8px;
        }
        .card-title span { font-size:18px; }
        
        /* è¼¸å…¥æ¨¡å¼åˆ‡æ› */
        .mode-tabs {
            display:flex;
            gap:10px;
            margin-bottom:20px;
        }
        .mode-tab {
            flex:1;
            padding:14px;
            background:var(--glass);
            border:1px solid var(--border);
            border-radius:12px;
            color:var(--text2);
            font-size:14px;
            cursor:pointer;
            transition:all 0.3s;
            display:flex;
            align-items:center;
            justify-content:center;
            gap:8px;
        }
        .mode-tab:hover { background:rgba(255,255,255,0.1); }
        .mode-tab.active {
            background:linear-gradient(135deg,var(--primary),var(--secondary));
            color:#fff;
            border-color:transparent;
        }
        
        /* æ–‡å­—è¼¸å…¥å€ */
        .input-section { display:block; }
        .input-section.hide { display:none; }
        
        textarea {
            width:100%;
            min-height:120px;
            padding:16px;
            background:rgba(0,0,0,0.3);
            border:1px solid var(--border);
            border-radius:12px;
            color:var(--text);
            font-size:15px;
            resize:vertical;
            font-family:inherit;
        }
        textarea:focus { outline:none; border-color:var(--primary); }
        textarea::placeholder { color:var(--text2); }
        
        /* è¼¸å…¥å€æ¨™é¡Œåˆ— */
        .input-header {
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:10px;
            font-size:13px;
            color:var(--text2);
        }
        .clear-btn {
            padding:6px 12px;
            background:rgba(239,68,68,0.15);
            border:1px solid rgba(239,68,68,0.3);
            border-radius:8px;
            color:#f87171;
            font-size:12px;
            cursor:pointer;
            transition:all 0.3s;
        }
        .clear-btn:hover {
            background:rgba(239,68,68,0.25);
            border-color:rgba(239,68,68,0.5);
        }
        .clear-image-btn {
            width:100%;
            margin-top:10px;
            padding:10px;
        }
        
        /* æ¨™é¡ŒæŒ‰éˆ•çµ„ */
        .header-btns {
            display:flex;
            gap:8px;
        }
        .enhance-btn {
            padding:6px 12px;
            background:linear-gradient(135deg,rgba(168,85,247,0.2),rgba(236,72,153,0.2));
            border:1px solid rgba(168,85,247,0.4);
            border-radius:8px;
            color:#c084fc;
            font-size:12px;
            cursor:pointer;
            transition:all 0.3s;
        }
        .enhance-btn:hover {
            background:linear-gradient(135deg,rgba(168,85,247,0.3),rgba(236,72,153,0.3));
            border-color:rgba(168,85,247,0.6);
            transform:scale(1.02);
        }
        
        /* AI å„ªåŒ–å¼•æ“é¸æ“‡ */
        .ai-enhance-row {
            display:flex;
            align-items:center;
            gap:10px;
            margin-top:16px;
            padding:12px;
            background:rgba(168,85,247,0.05);
            border:1px solid rgba(168,85,247,0.2);
            border-radius:12px;
        }
        .ai-enhance-label {
            font-size:13px;
            color:var(--text2);
        }
        .enhance-select {
            flex:1;
            padding:8px 12px;
            background:rgba(0,0,0,0.3);
            border:1px solid var(--border);
            border-radius:8px;
            color:var(--text);
            font-size:13px;
            cursor:pointer;
        }
        .enhance-select:focus { outline:none; border-color:var(--primary); }
        
        /* åœ–ç‰‡ä¸Šå‚³å€ */
        .upload-zone {
            border:2px dashed var(--border);
            border-radius:16px;
            padding:40px 20px;
            text-align:center;
            cursor:pointer;
            transition:all 0.3s;
        }
        .upload-zone:hover { border-color:var(--primary); background:rgba(168,85,247,0.05); }
        .upload-zone.has-image { border-style:solid; border-color:var(--accent); }
        .upload-icon { font-size:48px; margin-bottom:12px; }
        .upload-text { color:var(--text2); font-size:14px; }
        .upload-preview {
            max-width:100%;
            max-height:200px;
            border-radius:12px;
            display:none;
        }
        .upload-zone.has-image .upload-preview { display:block; margin:0 auto; }
        .upload-zone.has-image .upload-icon,
        .upload-zone.has-image .upload-text { display:none; }
        
        input[type="file"] { display:none; }
        
        /* æ¨¡å‹é¸æ“‡ */
        .model-grid {
            display:grid;
            grid-template-columns:repeat(2,1fr);
            gap:10px;
        }
        .model-option {
            padding:14px 12px;
            background:var(--glass);
            border:1px solid var(--border);
            border-radius:12px;
            cursor:pointer;
            transition:all 0.3s;
            text-align:center;
        }
        .model-option:hover { background:rgba(255,255,255,0.1); }
        .model-option.active {
            border-color:var(--primary);
            background:rgba(168,85,247,0.15);
        }
        .model-icon { font-size:24px; margin-bottom:6px; }
        .model-name { font-size:13px; font-weight:600; }
        .model-desc { font-size:10px; color:var(--text2); margin-top:4px; }
        
        .model-eta {
            margin-top:12px;
            padding:10px;
            background:rgba(6,182,212,0.1);
            border:1px solid rgba(6,182,212,0.3);
            border-radius:10px;
            font-size:13px;
            color:var(--accent);
            text-align:center;
        }
        
        /* èƒŒæ™¯ç”Ÿæˆæ¨¡å¼ */
        .bg-mode-row {
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:14px 16px;
            background:rgba(6,182,212,0.08);
            border:1px solid rgba(6,182,212,0.2);
            border-radius:12px;
            margin-bottom:16px;
        }
        .bg-mode-label {
            display:flex;
            align-items:center;
            gap:10px;
            cursor:pointer;
            font-size:14px;
        }
        .bg-mode-label input {
            width:18px;
            height:18px;
            accent-color:var(--accent);
        }
        .bg-mode-hint {
            font-size:11px;
            color:var(--text2);
        }
        
        /* å¹³å°é¸æ“‡ */
        .platform-select {
            width:100%;
            padding:12px;
            background:rgba(0,0,0,0.3);
            border:1px solid var(--border);
            border-radius:10px;
            color:var(--text);
            font-size:14px;
            cursor:pointer;
        }
        .platform-select:focus { outline:none; border-color:var(--primary); }
        .platform-status {
            margin-top:10px;
            padding:8px 12px;
            background:rgba(16,185,129,0.1);
            border:1px solid rgba(16,185,129,0.3);
            border-radius:8px;
            font-size:11px;
            color:#34d399;
        }
        
        /* è¨­å®šé¸é … */
        .option-row {
            display:flex;
            gap:12px;
            margin-bottom:12px;
        }
        .option-group {
            flex:1;
        }
        .option-label {
            font-size:12px;
            color:var(--text2);
            margin-bottom:8px;
        }
        .option-btns {
            display:flex;
            gap:6px;
        }
        .option-btn {
            flex:1;
            padding:10px 8px;
            background:var(--glass);
            border:1px solid var(--border);
            border-radius:8px;
            color:var(--text2);
            font-size:12px;
            cursor:pointer;
            transition:all 0.3s;
        }
        .option-btn:hover { background:rgba(255,255,255,0.1); }
        .option-btn.active {
            background:var(--primary);
            color:#fff;
            border-color:transparent;
        }
        
        /* ç”ŸæˆæŒ‰éˆ• */
        .gen-btn {
            width:100%;
            padding:18px;
            background:linear-gradient(135deg,var(--primary),var(--secondary));
            border:none;
            border-radius:16px;
            color:#fff;
            font-size:18px;
            font-weight:700;
            cursor:pointer;
            transition:all 0.3s;
            display:flex;
            align-items:center;
            justify-content:center;
            gap:10px;
        }
        .gen-btn:hover { transform:scale(1.02); box-shadow:0 10px 30px rgba(168,85,247,0.4); }
        .gen-btn:disabled { opacity:0.6; cursor:not-allowed; transform:none; }
        
        /* çµæœå€ */
        .result-card {
            display:none;
        }
        .result-card.show { display:block; }
        
        .video-wrap {
            position:relative;
            border-radius:12px;
            overflow:hidden;
            background:#000;
        }
        .video-wrap video {
            width:100%;
            display:block;
        }
        
        .result-info {
            padding:16px 0;
            font-size:13px;
            color:var(--text2);
        }
        .result-info-row {
            display:flex;
            justify-content:space-between;
            padding:6px 0;
            border-bottom:1px solid var(--border);
        }
        
        .result-actions {
            display:flex;
            gap:10px;
            margin-top:16px;
        }
        .action-btn {
            flex:1;
            padding:14px;
            border:none;
            border-radius:12px;
            font-size:14px;
            font-weight:600;
            cursor:pointer;
            display:flex;
            align-items:center;
            justify-content:center;
            gap:6px;
            transition:all 0.3s;
        }
        .action-btn:hover { transform:scale(1.02); }
        .action-btn.download { background:linear-gradient(135deg,#10b981,#059669); color:#fff; }
        .action-btn.share { background:linear-gradient(135deg,#3b82f6,#1d4ed8); color:#fff; }
        .action-btn.line { background:#06c755; color:#fff; }
        
        /* ç‹€æ…‹æç¤º */
        .status {
            padding:16px;
            border-radius:12px;
            margin-top:16px;
            font-size:14px;
            display:none;
        }
        .status.show { display:block; }
        .status.info { background:rgba(59,130,246,0.2); color:#60a5fa; }
        .status.ok { background:rgba(16,185,129,0.2); color:#34d399; }
        .status.err { background:rgba(239,68,68,0.2); color:#f87171; }
        
        /* é€²åº¦æ¢ */
        .progress-wrap {
            margin-top:16px;
            display:none;
        }
        .progress-wrap.show { display:block; }
        .progress-bar {
            height:8px;
            background:rgba(255,255,255,0.1);
            border-radius:4px;
            overflow:hidden;
        }
        .progress-fill {
            height:100%;
            background:linear-gradient(90deg,var(--primary),var(--secondary));
            width:0%;
            transition:width 0.3s;
        }
        .progress-text {
            text-align:center;
            font-size:12px;
            color:var(--text2);
            margin-top:8px;
        }
        
        /* åº•éƒ¨å°èˆª */
        .nav {
            position:fixed;
            bottom:0;
            left:0;
            right:0;
            background:rgba(10,10,15,0.95);
            backdrop-filter:blur(20px);
            border-top:1px solid var(--border);
            padding:10px 0;
            padding-bottom:max(10px, env(safe-area-inset-bottom));
        }
        .nav-inner {
            display:flex;
            justify-content:center;
            gap:40px;
            max-width:400px;
            margin:0 auto;
        }
        .nav-btn {
            background:none;
            border:none;
            color:var(--text2);
            font-size:12px;
            cursor:pointer;
            display:flex;
            flex-direction:column;
            align-items:center;
            gap:4px;
            transition:all 0.3s;
        }
        .nav-btn .icon { font-size:24px; }
        .nav-btn.active { color:var(--primary); }
        
        /* è¨­å®šé¢æ¿ */
        .settings {
            display:none;
            position:fixed;
            inset:0;
            background:var(--bg);
            z-index:100;
            overflow-y:auto;
            padding:20px 16px 100px;
        }
        .settings.show { display:block; }
        .settings-header {
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:20px;
        }
        .settings-title { font-size:20px; font-weight:700; }
        .settings-close {
            width:36px; height:36px;
            background:var(--glass);
            border:1px solid var(--border);
            border-radius:50%;
            color:var(--text);
            font-size:18px;
            cursor:pointer;
        }
        
        .setting-group {
            background:var(--card);
            border:1px solid var(--border);
            border-radius:16px;
            padding:16px;
            margin-bottom:12px;
        }
        .setting-label {
            font-size:12px;
            color:var(--text2);
            margin-bottom:8px;
        }
        .setting-input {
            width:100%;
            padding:12px;
            background:rgba(0,0,0,0.3);
            border:1px solid var(--border);
            border-radius:10px;
            color:var(--text);
            font-size:14px;
        }
        .setting-input:focus { outline:none; border-color:var(--primary); }
        
        .test-line-btn {
            width:100%;
            padding:12px;
            margin-top:10px;
            background:linear-gradient(135deg,#06c755,#04a344);
            border:none;
            border-radius:10px;
            color:#fff;
            font-size:14px;
            font-weight:600;
            cursor:pointer;
            transition:all 0.3s;
        }
        .test-line-btn:hover { transform:scale(1.02); opacity:0.9; }
        
        .save-btn {
            width:100%;
            padding:16px;
            background:linear-gradient(135deg,var(--primary),var(--secondary));
            border:none;
            border-radius:12px;
            color:#fff;
            font-size:16px;
            font-weight:600;
            cursor:pointer;
            margin-top:20px;
        }
        
        /* Loading */
        .loading {
            position:fixed;
            inset:0;
            background:rgba(0,0,0,0.8);
            display:none;
            justify-content:center;
            align-items:center;
            z-index:200;
            flex-direction:column;
            gap:20px;
        }
        .loading.show { display:flex; }
        .spinner {
            width:50px; height:50px;
            border:3px solid var(--border);
            border-top-color:var(--primary);
            border-radius:50%;
            animation:spin 1s linear infinite;
        }
        @keyframes spin { to { transform:rotate(360deg); } }
        .loading-text { color:var(--text); font-size:14px; text-align:center; }
        
        /* Toast */
        #toast {
            position:fixed;
            bottom:120px;
            left:50%;
            transform:translateX(-50%) translateY(100px);
            background:rgba(0,0,0,0.9);
            color:#fff;
            padding:12px 24px;
            border-radius:30px;
            font-size:14px;
            opacity:0;
            transition:all 0.3s;
            z-index:300;
            white-space:nowrap;
        }
        #toast.show { transform:translateX(-50%) translateY(0); opacity:1; }
    </style>
</head>
<body>
    <!-- é–‹æ©Ÿå‹•ç•« -->
    <div class="splash" id="splash" onclick="hideSplash()">
        <div class="grid-bg"></div>
        <div class="splash-container">
            <div class="ring-outer"></div>
            <div class="ring-mid"></div>
            <div class="char-box">
                <div class="char">å½±</div>
            </div>
            <div class="scan-line"></div>
            <div class="particles">
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
                <div class="particle"></div>
            </div>
        </div>
        <div class="splash-title">AI VIDEO</div>
        <div class="splash-sub">GENERATOR</div>
        <div class="loading-bar"></div>
    </div>

    <!-- ä¸»ç¨‹å¼ -->
    <div class="app">
        <div class="header">
            <h1>ğŸ¬ AI å½±ç‰‡ç”Ÿæˆå™¨</h1>
            <p>æ–‡å­—/åœ–ç‰‡ â†’ ç²¾å½©å½±ç‰‡</p>
        </div>

        <!-- è¼¸å…¥æ¨¡å¼ -->
        <div class="card">
            <div class="mode-tabs">
                <button class="mode-tab active" data-mode="text" onclick="setMode('text')">
                    <span>ğŸ“</span> æ–‡å­—ç”Ÿå½±ç‰‡
                </button>
                <button class="mode-tab" data-mode="image" onclick="setMode('image')">
                    <span>ğŸ–¼ï¸</span> åœ–ç‰‡ç”Ÿå½±ç‰‡
                </button>
            </div>

            <!-- æ–‡å­—è¼¸å…¥ -->
            <div class="input-section" id="textSection">
                <div class="input-header">
                    <span>âœï¸ å½±ç‰‡æè¿°</span>
                    <div class="header-btns">
                        <button class="enhance-btn" onclick="enhancePrompt('text')">âœ¨ AI å„ªåŒ–</button>
                        <button class="clear-btn" onclick="clearPrompt()">ğŸ—‘ï¸ æ¸…é™¤</button>
                    </div>
                </div>
                <textarea id="promptInput" placeholder="æè¿°ä½ æƒ³è¦çš„å½±ç‰‡å…§å®¹...&#10;&#10;ä¾‹å¦‚ï¼š&#10;â€¢ ä¸€éš»è²“å’ªåœ¨è‰åœ°ä¸Šå¥”è·‘&#10;â€¢ æ—¥è½æ™‚åˆ†çš„æµ·ç˜æµªèŠ±&#10;â€¢ æœªä¾†åŸå¸‚çš„éœ“è™¹ç‡ˆå¤œæ™¯&#10;&#10;ğŸ’¡ é»æ“Šã€ŒAI å„ªåŒ–ã€è®“æè¿°æ›´ç²¾å½©ï¼"></textarea>
            </div>

            <!-- åœ–ç‰‡ä¸Šå‚³ -->
            <div class="input-section hide" id="imageSection">
                <div class="upload-zone" id="uploadZone" onclick="document.getElementById('imageInput').click()">
                    <div class="upload-icon">ğŸ“·</div>
                    <div class="upload-text">é»æ“Šä¸Šå‚³åœ–ç‰‡<br><small>æ”¯æ´ JPGã€PNG</small></div>
                    <img class="upload-preview" id="imagePreview">
                </div>
                <button class="clear-btn clear-image-btn" id="clearImageBtn" onclick="clearImage(event)" style="display:none;">ğŸ—‘ï¸ ç§»é™¤åœ–ç‰‡</button>
                <input type="file" id="imageInput" accept="image/*" onchange="handleImageUpload(event)">
                <div class="input-header" style="margin-top:12px;">
                    <span>âœï¸ å‹•æ…‹æè¿°ï¼ˆé¸å¡«ï¼‰</span>
                    <div class="header-btns">
                        <button class="enhance-btn" onclick="enhancePrompt('image')">âœ¨ AI å„ªåŒ–</button>
                        <button class="clear-btn" onclick="clearImagePrompt()">ğŸ—‘ï¸ æ¸…é™¤</button>
                    </div>
                </div>
                <textarea id="imagePrompt" placeholder="æè¿°åœ–ç‰‡çš„å‹•æ…‹æ•ˆæœï¼ˆé¸å¡«ï¼‰&#10;ä¾‹å¦‚ï¼šè®“äººç‰©å¾®ç¬‘ã€è®“æ°´æµå‹•...&#10;&#10;ğŸ’¡ é»æ“Šã€ŒAI å„ªåŒ–ã€è®“å‹•æ…‹æ›´ç”Ÿå‹•ï¼"></textarea>
            </div>
            
            <!-- AI å„ªåŒ–æ¨¡å‹é¸æ“‡ -->
            <div class="ai-enhance-row">
                <span class="ai-enhance-label">ğŸ¤– å„ªåŒ–å¼•æ“ï¼š</span>
                <select id="enhanceModel" class="enhance-select">
                    <option value="auto">ğŸ”„ è‡ªå‹•ï¼ˆGemini å„ªå…ˆï¼‰</option>
                    <option value="gemini">ğŸ’ Gemini</option>
                    <option value="groq">âš¡ Groqï¼ˆå¿«é€Ÿï¼‰</option>
                </select>
            </div>
        </div>

        <!-- æ¨¡å‹é¸æ“‡ -->
        <div class="card">
            <div class="card-title"><span>ğŸ¤–</span> é¸æ“‡ AI æ¨¡å‹</div>
            <div class="model-grid">
                <div class="model-option" data-model="veo3-fast" onclick="setModel('veo3-fast')">
                    <div class="model-icon">âš¡</div>
                    <div class="model-name">Veo 3 Fast</div>
                    <div class="model-desc">å¿«é€Ÿ+éŸ³è¨Š ~1åˆ†é˜</div>
                </div>
                <div class="model-option active" data-model="veo3" onclick="setModel('veo3')">
                    <div class="model-icon">ğŸŒŸ</div>
                    <div class="model-name">Veo 3</div>
                    <div class="model-desc">é ‚ç´šå“è³ª ~3åˆ†é˜</div>
                </div>
                <div class="model-option" data-model="kling" onclick="setModel('kling')">
                    <div class="model-icon">ğŸ¬</div>
                    <div class="model-name">Kling 2.5</div>
                    <div class="model-desc">é›»å½±æ„Ÿ ~2åˆ†é˜</div>
                </div>
                <div class="model-option" data-model="hailuo" onclick="setModel('hailuo')">
                    <div class="model-icon">ğŸŒŠ</div>
                    <div class="model-name">Hailuo</div>
                    <div class="model-desc">ç©©å®š ~1.5åˆ†é˜</div>
                </div>
                <div class="model-option" data-model="wan" onclick="setModel('wan')">
                    <div class="model-icon">ğŸ†“</div>
                    <div class="model-name">Wan Video</div>
                    <div class="model-desc">å…è²»å¿«é€Ÿ ~1åˆ†é˜</div>
                </div>
                <div class="model-option" data-model="svd" onclick="setModel('svd')">
                    <div class="model-icon">ğŸï¸</div>
                    <div class="model-name">Stable Video</div>
                    <div class="model-desc">åœ–ç‰‡å‹•ç•« ~30ç§’</div>
                </div>
            </div>
            <div class="model-eta" id="modelEta">â±ï¸ é ä¼°æ™‚é–“ï¼š2-4åˆ†é˜</div>
        </div>

        <!-- å½±ç‰‡è¨­å®š -->
        <div class="card">
            <div class="card-title"><span>âš™ï¸</span> å½±ç‰‡è¨­å®š</div>
            <div class="option-row">
                <div class="option-group">
                    <div class="option-label">â±ï¸ å½±ç‰‡é•·åº¦</div>
                    <div class="option-btns">
                        <button class="option-btn active" data-duration="5" onclick="setDuration(5)">5 ç§’</button>
                        <button class="option-btn" data-duration="10" onclick="setDuration(10)">10 ç§’</button>
                    </div>
                </div>
                <div class="option-group">
                    <div class="option-label">ğŸ“ ç•«é¢æ¯”ä¾‹</div>
                    <div class="option-btns">
                        <button class="option-btn active" data-ratio="16:9" onclick="setRatio('16:9')">16:9</button>
                        <button class="option-btn" data-ratio="9:16" onclick="setRatio('9:16')">9:16</button>
                        <button class="option-btn" data-ratio="1:1" onclick="setRatio('1:1')">1:1</button>
                    </div>
                </div>
            </div>
            <div class="option-row" style="margin-top:12px;">
                <div class="option-group" style="flex:1;">
                    <div class="option-label">ğŸ”„ ç”Ÿæˆå¹³å°</div>
                    <select id="platformSelect" class="platform-select" onchange="setPlatform(this.value)">
                        <option value="auto">ğŸ”„ è‡ªå‹•å‚™æ´ï¼ˆæ¨è–¦ï¼‰</option>
                        <option value="fal">ğŸš€ fal.aiï¼ˆç©©å®šå¿«é€Ÿï¼‰</option>
                        <option value="replicate">ğŸ”® Replicate</option>
                    </select>
                </div>
            </div>
            <div class="platform-status" id="platformStatus">ğŸ”„ è‡ªå‹•æ¨¡å¼ï¼šå„ªå…ˆ fal.aiï¼Œå¤±æ•—è‡ªå‹•åˆ‡æ› Replicate</div>
        </div>

        <!-- èƒŒæ™¯ç”Ÿæˆé¸é … -->
        <div class="bg-mode-row">
            <label class="bg-mode-label">
                <input type="checkbox" id="bgMode" onchange="toggleBgMode()">
                <span class="checkmark"></span>
                <span>ğŸ“² èƒŒæ™¯ç”Ÿæˆæ¨¡å¼</span>
            </label>
            <span class="bg-mode-hint">å¯é—œé–‰é é¢ï¼Œå®Œæˆå¾Œ LINE é€šçŸ¥</span>
        </div>

        <!-- ç”ŸæˆæŒ‰éˆ• -->
        <button class="gen-btn" id="genBtn" onclick="generateVideo()">
            <span>ğŸ¬</span> ç”Ÿæˆå½±ç‰‡
        </button>

        <!-- é€²åº¦é¡¯ç¤º -->
        <div class="progress-wrap" id="progressWrap">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">æº–å‚™ä¸­...</div>
        </div>

        <!-- ç‹€æ…‹æç¤º -->
        <div class="status" id="statusBox"></div>

        <!-- çµæœå€ -->
        <div class="card result-card" id="resultCard">
            <div class="card-title"><span>âœ…</span> å½±ç‰‡ç”Ÿæˆå®Œæˆ</div>
            <div class="video-wrap">
                <video id="resultVideo" controls playsinline></video>
            </div>
            <div class="result-info">
                <div class="result-info-row">
                    <span>æ¨¡å‹</span>
                    <span id="resultModel">--</span>
                </div>
                <div class="result-info-row">
                    <span>é•·åº¦</span>
                    <span id="resultDuration">--</span>
                </div>
                <div class="result-info-row">
                    <span>ç”Ÿæˆæ™‚é–“</span>
                    <span id="resultTime">--</span>
                </div>
            </div>
            <div class="result-actions">
                <button class="action-btn download" onclick="downloadVideo()">
                    <span>ğŸ“¥</span> ä¸‹è¼‰
                </button>
                <button class="action-btn share" onclick="shareVideo()">
                    <span>ğŸ“¤</span> åˆ†äº«
                </button>
                <button class="action-btn line" onclick="pushToLine()">
                    <span>ğŸ’¬</span> LINE
                </button>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text" id="loadingText">ç”Ÿæˆä¸­...</div>
    </div>

    <!-- Toast -->
    <div id="toast"></div>

    <!-- åº•éƒ¨å°èˆª -->
    <nav class="nav">
        <div class="nav-inner">
            <button class="nav-btn active" onclick="showPage('home',this)">
                <span class="icon">ğŸ </span>
                <span>é¦–é </span>
            </button>
            <button class="nav-btn" onclick="showPage('settings',this)">
                <span class="icon">âš™ï¸</span>
                <span>è¨­å®š</span>
            </button>
        </div>
    </nav>

    <!-- è¨­å®šé¢æ¿ -->
    <div class="settings" id="settings">
        <div class="settings-header">
            <div class="settings-title">âš™ï¸ API è¨­å®š</div>
            <button class="settings-close" onclick="closeSettings()">âœ•</button>
        </div>

        <div class="setting-group">
            <div class="setting-label">ğŸ”— GAS éƒ¨ç½² URL</div>
            <input type="url" class="setting-input" id="gasUrl" placeholder="https://script.google.com/...">
        </div>

        <div class="setting-group">
            <div class="setting-label">ğŸ”‘ Replicate API Token</div>
            <input type="password" class="setting-input" id="repToken" placeholder="r8_...">
            <div style="font-size:11px;color:var(--text2);margin-top:6px;">
                <a href="https://replicate.com/account/api-tokens" target="_blank" style="color:var(--accent);">å–å¾— Token â†’</a>
            </div>
        </div>
        
        <div class="setting-group">
            <div class="setting-label">ğŸš€ fal.ai API Keyï¼ˆå‚™æ´å¹³å°ï¼‰</div>
            <input type="password" class="setting-input" id="falKey" placeholder="...">
            <div style="font-size:11px;color:var(--text2);margin-top:6px;">
                <a href="https://fal.ai/dashboard/keys" target="_blank" style="color:var(--accent);">å–å¾— Key â†’</a> æ›´ç©©å®šã€é€Ÿåº¦æ›´å¿«
            </div>
        </div>

        <div class="setting-group">
            <div class="setting-label">ğŸ‘¤ LINE User ID</div>
            <input type="text" class="setting-input" id="lineUserId" placeholder="U...">
            <button class="test-line-btn" onclick="testLineConnection()">ğŸ”— æ¸¬è©¦ LINE é€£ç·š</button>
        </div>

        <div class="setting-group">
            <div class="setting-label">ğŸ–¼ï¸ ImgBB API Keyï¼ˆä¸Šå‚³åœ–ç‰‡ç”¨ï¼‰</div>
            <input type="password" class="setting-input" id="imgbbKey" placeholder="...">
            <div style="font-size:11px;color:var(--text2);margin-top:6px;">
                <a href="https://api.imgbb.com/" target="_blank" style="color:var(--accent);">å–å¾— Key â†’</a>
            </div>
        </div>
        
        <div class="setting-group" style="border:1px solid rgba(168,85,247,0.3);background:rgba(168,85,247,0.05);">
            <div class="setting-label" style="color:#c084fc;">âœ¨ AI æç¤ºè©å„ªåŒ–ï¼ˆäºŒé¸ä¸€å³å¯ï¼‰</div>
            
            <div style="margin-top:12px;">
                <div class="setting-label">ğŸ’ Gemini API Key</div>
                <input type="password" class="setting-input" id="geminiKey" placeholder="AIza...">
                <div style="font-size:11px;color:var(--text2);margin-top:6px;">
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color:var(--accent);">å–å¾— Key â†’</a> å…è²»é¡åº¦å¤§
                </div>
            </div>
            
            <div style="margin-top:12px;">
                <div class="setting-label">âš¡ Groq API Key</div>
                <input type="password" class="setting-input" id="groqKey" placeholder="gsk_...">
                <div style="font-size:11px;color:var(--text2);margin-top:6px;">
                    <a href="https://console.groq.com/keys" target="_blank" style="color:var(--accent);">å–å¾— Key â†’</a> é€Ÿåº¦è¶…å¿«
                </div>
            </div>
        </div>

        <button class="save-btn" onclick="saveSettings()">ğŸ’¾ å„²å­˜è¨­å®š</button>
    </div>

    <script>
    // ========== è¨­å®š ==========
    const KEYS = ['gasUrl', 'repToken', 'falKey', 'lineUserId', 'imgbbKey', 'geminiKey', 'groqKey'];
    let cfg = {};
    
    // æ¨¡å‹è¨­å®š
    const MODELS = {
        'veo3-fast': { name: 'Veo 3 Fast', model: 'google/veo-3-fast', type: 'both', eta: '30-60ç§’' },
        'veo3': { name: 'Google Veo 3', model: 'google/veo-3', type: 'both', eta: '2-4åˆ†é˜' },
        'kling': { name: 'Kling 2.5', model: 'kling-ai/kling-2.5-turbo-pro', type: 'both', eta: '1-3åˆ†é˜' },
        'hailuo': { name: 'Hailuo', model: 'minimax/video-01', type: 'both', eta: '1-2åˆ†é˜' },
        'wan': { name: 'Wan Video', model: 'wan-video/wan-2.1-t2v-480p', type: 'text', eta: '30-90ç§’' },
        'svd': { name: 'Stable Video', model: 'stability-ai/stable-video-diffusion', type: 'image', eta: '20-40ç§’' }
    };
    
    // ç‹€æ…‹
    let currentMode = 'text';
    let currentModel = 'veo3';
    let currentDuration = 5;
    let currentRatio = '16:9';
    let currentPlatform = 'auto';
    let uploadedImage = null;
    let generatedVideoUrl = null;
    let currentPredictionId = null; // è¿½è¹¤ç”Ÿæˆ ID
    
    // ========== åˆå§‹åŒ– ==========
    document.addEventListener('DOMContentLoaded', () => {
        try {
            loadSettings();
        } catch(e) {
            console.error('loadSettings error:', e);
        }
        
        // 3ç§’å¾Œè‡ªå‹•é—œé–‰é–‹æ©Ÿç•«é¢
        setTimeout(hideSplash, 3000);
    });
    
    // é»æ“Šä¹Ÿèƒ½é—œé–‰é–‹æ©Ÿç•«é¢
    function hideSplash() {
        const splash = document.getElementById('splash');
        if (splash) splash.classList.add('hide');
    }
    
    // å‚™æ´ï¼š5ç§’å¾Œå¼·åˆ¶é—œé–‰
    setTimeout(hideSplash, 5000);
    
    function loadSettings() {
        KEYS.forEach(k => {
            cfg[k] = localStorage.getItem('video_' + k) || '';
            const el = document.getElementById(k);
            if (el) el.value = cfg[k];
        });
    }
    
    function saveSettings() {
        KEYS.forEach(k => {
            const el = document.getElementById(k);
            if (el) {
                cfg[k] = el.value.trim();
                localStorage.setItem('video_' + k, cfg[k]);
            }
        });
        toast('âœ… è¨­å®šå·²å„²å­˜');
        closeSettings();
    }
    
    // ========== LINE é€£ç·šæ¸¬è©¦ ==========
    async function testLineConnection() {
        // å…ˆå„²å­˜è¨­å®š
        saveSettings();
        
        if (!cfg.gasUrl) {
            toast('âš ï¸ è«‹å…ˆè¨­å®š GAS URL');
            return;
        }
        if (!cfg.lineUserId) {
            toast('âš ï¸ è«‹å…ˆè¨­å®š LINE User ID');
            return;
        }
        
        showLoading(true, 'ğŸ”— æ¸¬è©¦ LINE é€£ç·šä¸­...');
        
        try {
            const res = await fetch(cfg.gasUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
                body: JSON.stringify({
                    action: 'testLine',
                    userId: cfg.lineUserId
                })
            });
            
            const data = await res.json();
            
            if (data.ok) {
                toast('âœ… LINE é€£ç·šæˆåŠŸï¼è«‹æŸ¥çœ‹ LINE');
            } else {
                toast('âŒ ' + (data.err || 'é€£ç·šå¤±æ•—'));
            }
        } catch (e) {
            console.error(e);
            toast('âŒ é€£ç·šå¤±æ•—ï¼š' + e.message);
        } finally {
            showLoading(false);
        }
    }
    
    // ========== UI æ§åˆ¶ ==========
    function showPage(page, btn) {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        if (page === 'settings') {
            document.getElementById('settings').classList.add('show');
        } else {
            closeSettings();
        }
    }
    
    function closeSettings() {
        document.getElementById('settings').classList.remove('show');
    }
    
    function setMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.mode-tab').forEach(t => t.classList.toggle('active', t.dataset.mode === mode));
        document.getElementById('textSection').classList.toggle('hide', mode !== 'text');
        document.getElementById('imageSection').classList.toggle('hide', mode !== 'image');
        
        // è‡ªå‹•èª¿æ•´æ¨¡å‹
        if (mode === 'image' && MODELS[currentModel].type === 'text') {
            setModel('svd');
        }
        if (mode === 'text' && MODELS[currentModel].type === 'image') {
            setModel('kling');
        }
    }
    
    function setModel(model) {
        currentModel = model;
        document.querySelectorAll('.model-option').forEach(m => m.classList.toggle('active', m.dataset.model === model));
        
        // æ›´æ–°é ä¼°æ™‚é–“
        const m = MODELS[model];
        document.getElementById('modelEta').textContent = `â±ï¸ é ä¼°æ™‚é–“ï¼š${m.eta}`;
        
        // æª¢æŸ¥æ¨¡å‹æ˜¯å¦æ”¯æ´ç•¶å‰æ¨¡å¼
        if (m.type === 'text' && currentMode === 'image') {
            toast('âš ï¸ æ­¤æ¨¡å‹åƒ…æ”¯æ´æ–‡å­—ç”Ÿå½±ç‰‡');
            setMode('text');
        }
        if (m.type === 'image' && currentMode === 'text') {
            toast('âš ï¸ æ­¤æ¨¡å‹åƒ…æ”¯æ´åœ–ç‰‡ç”Ÿå½±ç‰‡');
            setMode('image');
        }
    }
    
    function setDuration(d) {
        currentDuration = d;
        document.querySelectorAll('[data-duration]').forEach(b => b.classList.toggle('active', b.dataset.duration == d));
    }
    
    function setRatio(r) {
        currentRatio = r;
        document.querySelectorAll('[data-ratio]').forEach(b => b.classList.toggle('active', b.dataset.ratio === r));
    }
    
    function setPlatform(p) {
        currentPlatform = p;
        const statusEl = document.getElementById('platformStatus');
        if (p === 'auto') {
            statusEl.textContent = 'ğŸ”„ è‡ªå‹•æ¨¡å¼ï¼šå„ªå…ˆ fal.aiï¼Œå¤±æ•—è‡ªå‹•åˆ‡æ› Replicate';
            statusEl.style.background = 'rgba(16,185,129,0.1)';
            statusEl.style.borderColor = 'rgba(16,185,129,0.3)';
            statusEl.style.color = '#34d399';
        } else if (p === 'fal') {
            statusEl.textContent = 'ğŸš€ ä½¿ç”¨ fal.ai å¹³å°ï¼ˆç©©å®šå¿«é€Ÿï¼‰';
            statusEl.style.background = 'rgba(59,130,246,0.1)';
            statusEl.style.borderColor = 'rgba(59,130,246,0.3)';
            statusEl.style.color = '#60a5fa';
        } else {
            statusEl.textContent = 'ğŸ”® ä½¿ç”¨ Replicate å¹³å°';
            statusEl.style.background = 'rgba(168,85,247,0.1)';
            statusEl.style.borderColor = 'rgba(168,85,247,0.3)';
            statusEl.style.color = '#c084fc';
        }
    }
    
    // ========== åœ–ç‰‡ä¸Šå‚³ ==========
    function handleImageUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (ev) => {
            uploadedImage = ev.target.result;
            document.getElementById('imagePreview').src = uploadedImage;
            document.getElementById('uploadZone').classList.add('has-image');
            document.getElementById('clearImageBtn').style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
    
    // ========== æ¸…é™¤åŠŸèƒ½ ==========
    function clearPrompt() {
        document.getElementById('promptInput').value = '';
        toast('âœ… å·²æ¸…é™¤');
    }
    
    function clearImagePrompt() {
        document.getElementById('imagePrompt').value = '';
        toast('âœ… å·²æ¸…é™¤');
    }
    
    function clearImage(e) {
        e.stopPropagation();
        uploadedImage = null;
        document.getElementById('imageInput').value = '';
        document.getElementById('imagePreview').src = '';
        document.getElementById('uploadZone').classList.remove('has-image');
        document.getElementById('clearImageBtn').style.display = 'none';
        toast('âœ… å·²ç§»é™¤åœ–ç‰‡');
    }
    
    // ========== AI å„ªåŒ–æç¤ºè© ==========
    async function enhancePrompt(type) {
        const textarea = type === 'text' 
            ? document.getElementById('promptInput')
            : document.getElementById('imagePrompt');
        
        const originalPrompt = textarea.value.trim();
        
        if (!originalPrompt) {
            toast('âš ï¸ è«‹å…ˆè¼¸å…¥æè¿°å…§å®¹');
            return;
        }
        
        if (!cfg.gasUrl) {
            toast('âš ï¸ è«‹å…ˆè¨­å®š GAS URL');
            return;
        }
        
        if (!cfg.geminiKey && !cfg.groqKey) {
            toast('âš ï¸ è«‹å…ˆè¨­å®š Gemini æˆ– Groq API Key');
            return;
        }
        
        const enhanceModel = document.getElementById('enhanceModel').value;
        
        showLoading(true, 'âœ¨ AI å„ªåŒ–ä¸­...');
        
        try {
            const res = await fetch(cfg.gasUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
                body: JSON.stringify({
                    action: 'enhancePrompt',
                    prompt: originalPrompt,
                    type: type, // 'text' æˆ– 'image'
                    model: enhanceModel,
                    geminiKey: cfg.geminiKey,
                    groqKey: cfg.groqKey
                })
            });
            
            const data = await res.json();
            
            if (data.ok && data.enhanced) {
                textarea.value = data.enhanced;
                toast(`âœ… å·²ç”¨ ${data.usedModel} å„ªåŒ–ï¼`);
            } else {
                throw new Error(data.err || 'å„ªåŒ–å¤±æ•—');
            }
            
        } catch (e) {
            console.error(e);
            toast('âŒ ' + e.message);
        } finally {
            showLoading(false);
        }
    }
    
    // ========== èƒŒæ™¯æ¨¡å¼ ==========
    let bgModeEnabled = false;
    
    function toggleBgMode() {
        bgModeEnabled = document.getElementById('bgMode').checked;
        if (bgModeEnabled && !cfg.lineUserId) {
            toast('âš ï¸ è«‹å…ˆè¨­å®š LINE User ID ä»¥æ¥æ”¶é€šçŸ¥');
            document.getElementById('bgMode').checked = false;
            bgModeEnabled = false;
        }
    }
    
    // ========== ç”Ÿæˆå½±ç‰‡ ==========
    async function generateVideo() {
        // é©—è­‰
        if (!cfg.gasUrl) { toast('âš ï¸ è«‹å…ˆè¨­å®š GAS URL'); return; }
        
        const prompt = currentMode === 'text' 
            ? document.getElementById('promptInput').value.trim()
            : document.getElementById('imagePrompt').value.trim();
        
        if (currentMode === 'text' && !prompt) {
            toast('âš ï¸ è«‹è¼¸å…¥å½±ç‰‡æè¿°');
            return;
        }
        
        if (currentMode === 'image' && !uploadedImage) {
            toast('âš ï¸ è«‹ä¸Šå‚³åœ–ç‰‡');
            return;
        }
        
        // èƒŒæ™¯æ¨¡å¼éœ€è¦ LINE
        const bgMode = document.getElementById('bgMode').checked;
        if (bgMode && !cfg.lineUserId) {
            toast('âš ï¸ èƒŒæ™¯æ¨¡å¼éœ€è¦è¨­å®š LINE User ID');
            return;
        }
        
        // é–‹å§‹ç”Ÿæˆ
        const eta = MODELS[currentModel].eta;
        showLoading(true, `ğŸ¬ å½±ç‰‡ç”Ÿæˆä¸­...\nâ±ï¸ é ä¼° ${eta}`);
        showProgress(true);
        updateStatus('â³ æ­£åœ¨æ’éšŠç”Ÿæˆ...', 'info');
        
        const startTime = Date.now();
        
        try {
            const res = await fetch(cfg.gasUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
                body: JSON.stringify({
                    action: 'generateVideo',
                    mode: currentMode,
                    prompt: prompt,
                    image: currentMode === 'image' ? uploadedImage : null,
                    model: currentModel,
                    duration: currentDuration,
                    ratio: currentRatio,
                    platform: currentPlatform,
                    falKey: cfg.falKey,
                    bgMode: bgMode,
                    lineUserId: cfg.lineUserId
                })
            });
            
            const data = await res.json();
            
            if (data.ok) {
                currentPredictionId = data.id;
                const usedPlatform = data.platform || 'replicate';
                
                // èƒŒæ™¯æ¨¡å¼ï¼šæç¤ºå¯é—œé–‰é é¢
                if (bgMode) {
                    showLoading(false);
                    showProgress(false);
                    const platformLabel = usedPlatform === 'fal' ? 'fal.ai' : 'Replicate';
                    updateStatus(`ğŸ“² èƒŒæ™¯ç”Ÿæˆä¸­ (${platformLabel})ï¼\nå®Œæˆå¾Œå°‡æ”¶åˆ° LINE é€šçŸ¥ï¼Œå¯ä»¥é—œé–‰æ­¤é é¢`, 'ok');
                    toast('ğŸ“² å·²å•Ÿå‹•èƒŒæ™¯ç”Ÿæˆï¼');
                    
                    // å„²å­˜åˆ° localStorage ä»¥ä¾¿ä¹‹å¾Œæ¢å¾©
                    localStorage.setItem('video_pending', JSON.stringify({
                        id: data.id,
                        platform: usedPlatform,
                        model: currentModel,
                        startTime: startTime
                    }));
                } else {
                    // å‰å°æ¨¡å¼ï¼šè¼ªè©¢ç‹€æ…‹
                    await pollStatus(data.id, startTime, usedPlatform);
                }
            } else {
                throw new Error(data.err || 'ç”Ÿæˆå¤±æ•—');
            }
            
        } catch (e) {
            console.error(e);
            updateStatus('âŒ ' + e.message, 'err');
            toast('âŒ ç”Ÿæˆå¤±æ•—');
            showLoading(false);
        }
    }
    
    async function pollStatus(id, startTime, platform) {
        const maxAttempts = 120; // æœ€å¤šç­‰ 10 åˆ†é˜
        let attempt = 0;
        
        while (attempt < maxAttempts) {
            attempt++;
            
            try {
                const res = await fetch(cfg.gasUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
                    body: JSON.stringify({
                        action: 'checkStatus',
                        id: id,
                        platform: platform,
                        falKey: cfg.falKey
                    })
                });
                
                const data = await res.json();
                
                if (data.status === 'succeeded') {
                    // æˆåŠŸï¼
                    generatedVideoUrl = data.output;
                    const elapsed = Math.round((Date.now() - startTime) / 1000);
                    updateProgress(100, 'âœ… å®Œæˆï¼');
                    showResult(elapsed, platform);
                    updateStatus(`âœ… å½±ç‰‡ç”Ÿæˆå®Œæˆï¼(${platform === 'fal' ? 'fal.ai' : 'Replicate'})`, 'ok');
                    showProgress(false);
                    showLoading(false);
                    toast('ğŸ‰ å½±ç‰‡ç”Ÿæˆå®Œæˆï¼');
                    return;
                } else if (data.status === 'failed') {
                    throw new Error(data.error || 'ç”Ÿæˆå¤±æ•—');
                } else {
                    // ä½¿ç”¨ GAS è¿”å›çš„é€²åº¦ï¼Œæˆ–ä¼°ç®—é€²åº¦
                    const elapsed = Math.round((Date.now() - startTime) / 1000);
                    const progress = data.progress || Math.min(90, attempt * 1.5);
                    const msg = data.progressMsg || `è™•ç†ä¸­... ${elapsed}ç§’`;
                    const platformLabel = platform === 'fal' ? 'ğŸš€ fal.ai' : 'ğŸ”® Replicate';
                    updateProgress(progress, `${msg} (${elapsed}s)`);
                    updateLoadingText(`ğŸ¬ ${msg}\n${platformLabel}\nâ±ï¸ å·²ç­‰å¾… ${elapsed} ç§’`);
                }
                
            } catch (e) {
                console.error('Poll error:', e);
            }
            
            // ç­‰å¾… 5 ç§’å¾Œå†æŸ¥è©¢
            await new Promise(r => setTimeout(r, 5000));
        }
        
        throw new Error('ç”Ÿæˆè¶…æ™‚ï¼Œè«‹é‡è©¦');
    }
    
    function updateLoadingText(text) {
        document.getElementById('loadingText').innerHTML = text.replace(/\n/g, '<br>');
    }
    
    function showResult(elapsed, platform) {
        document.getElementById('resultCard').classList.add('show');
        document.getElementById('resultVideo').src = generatedVideoUrl;
        document.getElementById('resultModel').textContent = MODELS[currentModel].name;
        document.getElementById('resultDuration').textContent = currentDuration + ' ç§’';
        document.getElementById('resultTime').textContent = elapsed + ' ç§’';
        // é¡¯ç¤ºä½¿ç”¨çš„å¹³å°
        const platformText = platform === 'fal' ? ' (fal.ai)' : ' (Replicate)';
        document.getElementById('resultModel').textContent += platformText;
    }
    
    // ========== ä¸‹è¼‰/åˆ†äº« ==========
    function downloadVideo() {
        if (!generatedVideoUrl) return;
        
        const link = document.createElement('a');
        link.href = generatedVideoUrl;
        link.download = `ai_video_${Date.now()}.mp4`;
        link.click();
        toast('âœ… é–‹å§‹ä¸‹è¼‰');
    }
    
    async function shareVideo() {
        if (!generatedVideoUrl) return;
        
        if (navigator.share) {
            try {
                await navigator.share({
                    title: 'AI ç”Ÿæˆå½±ç‰‡',
                    text: 'çœ‹çœ‹æˆ‘ç”¨ AI ç”Ÿæˆçš„å½±ç‰‡ï¼',
                    url: generatedVideoUrl
                });
            } catch (e) {
                copyToClipboard(generatedVideoUrl);
            }
        } else {
            copyToClipboard(generatedVideoUrl);
        }
    }
    
    async function pushToLine() {
        if (!generatedVideoUrl) return;
        if (!cfg.lineUserId) { toast('âš ï¸ è«‹å…ˆè¨­å®š LINE User ID'); return; }
        
        showLoading(true, 'ğŸ’¬ æ¨é€åˆ° LINE...');
        
        try {
            await fetch(cfg.gasUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
                body: JSON.stringify({
                    action: 'pushVideoToLine',
                    videoUrl: generatedVideoUrl,
                    userId: cfg.lineUserId,
                    model: MODELS[currentModel].name,
                    duration: currentDuration
                }),
                mode: 'no-cors'
            });
            
            toast('âœ… å·²æ¨é€åˆ° LINEï¼');
        } catch (e) {
            toast('âŒ æ¨é€å¤±æ•—');
        } finally {
            showLoading(false);
        }
    }
    
    // ========== å·¥å…·å‡½æ•¸ ==========
    function showLoading(show, text = '') {
        document.getElementById('loading').classList.toggle('show', show);
        document.getElementById('loadingText').innerHTML = text.replace(/\n/g, '<br>');
        document.getElementById('genBtn').disabled = show;
    }
    
    function showProgress(show) {
        document.getElementById('progressWrap').classList.toggle('show', show);
    }
    
    function updateProgress(percent, text) {
        document.getElementById('progressFill').style.width = percent + '%';
        document.getElementById('progressText').textContent = text;
    }
    
    function updateStatus(msg, type) {
        const el = document.getElementById('statusBox');
        el.textContent = msg;
        el.className = 'status show ' + type;
    }
    
    function toast(msg) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2500);
    }
    
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            toast('âœ… å·²è¤‡è£½é€£çµ');
        }).catch(() => {
            toast('âš ï¸ è¤‡è£½å¤±æ•—');
        });
    }
    </script>
</body>
</html>
